<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <title>ê´€ë¦¬ì í˜ì´ì§€ | PNU Place</title>
  <style>
    body { font-family: 'Pretendard', sans-serif; margin: 0; background: #f0f2f5; }
    header { background: #343a40; color: white; padding: 1rem 2rem; display: flex; justify-content: space-between; align-items: center; }

    .container { max-width: 1000px; margin: 30px auto; display: flex; flex-direction: column; gap: 30px; }

    /* ì¹´ë“œ ê³µí†µ ìŠ¤íƒ€ì¼ */
    .card { background: white; padding: 25px; border-radius: 12px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
    h2 { border-bottom: 2px solid #eee; padding-bottom: 15px; margin-top: 0; color: #333; font-size: 1.5rem; }

    /* í…Œì´ë¸” ìŠ¤íƒ€ì¼ */
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 12px; text-align: left; border-bottom: 1px solid #ddd; }
    th { background: #f8f9fa; font-weight: 600; color: #555; }

    /* ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    .btn { padding: 8px 14px; border: none; border-radius: 6px; cursor: pointer; color: white; font-size: 0.9rem; font-weight: 600; transition: 0.2s; }
    .btn:disabled { background: #ccc; cursor: not-allowed; }
    .btn-resolve { background: #28a745; }
    .btn-resolve:hover { background: #218838; }
    .btn-return { background: #ffc107; color: #333; }
    .btn-return:hover { background: #e0a800; }
    .btn-disable { background: #dc3545; }
    .btn-disable:hover { background: #c82333; }

    /* ì¢Œì„ ê´€ë¦¬ ì»¨íŠ¸ë¡¤ ìŠ¤íƒ€ì¼ */
    .control-panel { display: flex; gap: 15px; align-items: center; flex-wrap: wrap; margin-bottom: 15px; }
    select { padding: 10px; border-radius: 6px; border: 1px solid #ddd; font-size: 1rem; min-width: 200px; }
    .seat-status-info { margin-left: auto; font-weight: bold; color: #005baa; }

    .status-badge { padding: 4px 8px; border-radius: 12px; font-size: 0.8rem; font-weight: bold; }
    .status-pending { background: #ffeeba; color: #856404; }
    .status-resolved { background: #d4edda; color: #155724; }
  </style>
</head>
<body>
<header>
  <div style="font-weight:bold; font-size:1.2rem;">ê´€ë¦¬ì ëŒ€ì‹œë³´ë“œ</div>
  <a href="/rooms.html" style="color:white; text-decoration:none;">Home</a>
</header>

<div class="container">

  <section class="card">
    <h2>ğŸ› ï¸ ì¢Œì„ ê°œë³„ ê´€ë¦¬</h2>
    <p style="color:#666; margin-bottom: 20px;">íŠ¹ì • ì¢Œì„ì„ ì„ íƒí•˜ì—¬ ê°•ì œë¡œ ë°˜ë‚©ì‹œí‚¤ê±°ë‚˜ ì‚¬ìš© ë¶ˆê°€ ìƒíƒœë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>

    <div class="control-panel">
      <select id="room-select" onchange="loadSeats(this.value)">
        <option value="">ì—´ëŒì‹¤ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>

      <select id="seat-select" disabled onchange="updateSeatInfo()">
        <option value="">ì¢Œì„ì„ ì„ íƒí•˜ì„¸ìš”</option>
      </select>

      <div id="seat-status-display" class="seat-status-info"></div>
    </div>

    <div class="control-panel" style="justify-content: flex-end; margin-top: 20px;">
      <button id="btn-force-return" class="btn btn-return" onclick="handleForceReturn()" disabled>ê°•ì œ ë°˜ë‚© (í‡´ì‹¤)</button>
      <button id="btn-disable-seat" class="btn btn-disable" onclick="handleDisableSeat()" disabled>ì‚¬ìš© ë¶ˆê°€ (ì ê²€)</button>
    </div>
  </section>

  <section class="card">
    <h2>ğŸš« ì‚¬ìš© ë¶ˆê°€ ì¢Œì„ ê´€ë¦¬ (ì‹ ê³  ë° ì ê²€)</h2>
    <p style="color:#666; margin-bottom: 10px; font-size: 0.9em;">
      í˜„ì¬ 'ì‚¬ìš© ë¶ˆê°€(UNUSABLE)' ìƒíƒœì¸ ëª¨ë“  ì¢Œì„ ëª©ë¡ì…ë‹ˆë‹¤.<br>
      ì‹ ê³ ëœ ì¢Œì„ê³¼ ê´€ë¦¬ìê°€ ì§ì ‘ ë§‰ì€ ì¢Œì„ì´ ëª¨ë‘ í‘œì‹œë©ë‹ˆë‹¤. [ë³µêµ¬] ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ë‹¤ì‹œ ì´ìš© ê°€ëŠ¥í•´ì§‘ë‹ˆë‹¤.
    </p>
    <table>
      <thead>
      <tr>
        <th>ìœ„ì¹˜</th>
        <th>ìƒíƒœ</th>
        <th>ì‚¬ìœ  (ì‹ ê³ ë‚´ìš© ë“±)</th>
        <th>ì ‘ìˆ˜ì¼ì‹œ</th>
        <th>ì‘ì—…</th>
      </tr>
      </thead>
      <tbody id="unusable-list">
      <tr><td colspan="5" style="text-align:center; padding: 20px;">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</td></tr>
      </tbody>
    </table>
  </section>

</div>

<script>
  // ===============================================
  // 1. ê³µí†µ ë°ì´í„° ë¡œë“œ (ì—´ëŒì‹¤ ëª©ë¡)
  // ===============================================
  async function loadRooms() {
    try {
      const res = await fetch('/api/rooms', { credentials: 'same-origin' });
      const rooms = await res.json();
      const select = document.getElementById('room-select');

      // ì¤‘ë³µ ì¶”ê°€ ë°©ì§€ (í˜¹ì‹œ ëª¨ë¥¼ ìƒí™© ëŒ€ë¹„)
      select.innerHTML = '<option value="">ì—´ëŒì‹¤ì„ ì„ íƒí•˜ì„¸ìš”</option>';

      rooms.forEach(room => {
        const option = document.createElement('option');
        option.value = room.id;
        option.textContent = `${room.name} (${room.floor}ì¸µ)`;
        select.appendChild(option);
      });
    } catch(e) { console.error(e); }
  }

  // ===============================================
  // 2. ìƒë‹¨: ê°œë³„ ì¢Œì„ ê´€ë¦¬ ë¡œì§
  // ===============================================
  let currentSeats = [];

  // íŠ¹ì • ì—´ëŒì‹¤ì˜ ì¢Œì„ ëª©ë¡ ê°€ì ¸ì˜¤ê¸°
  async function loadSeats(roomId) {
    const seatSelect = document.getElementById('seat-select');
    const statusDisplay = document.getElementById('seat-status-display');
    const btnReturn = document.getElementById('btn-force-return');
    const btnDisable = document.getElementById('btn-disable-seat');

    // UI ì´ˆê¸°í™”
    seatSelect.innerHTML = '<option value="">ì¢Œì„ì„ ì„ íƒí•˜ì„¸ìš”</option>';
    seatSelect.disabled = true;
    statusDisplay.textContent = '';
    btnReturn.disabled = true;
    btnDisable.disabled = true;
    currentSeats = [];

    if (!roomId) return;

    try {
      const res = await fetch(`/api/rooms/${roomId}/seats`, { credentials: 'same-origin' });
      const data = await res.json();
      currentSeats = data.seats;

      // ë³´ê¸° ì¢‹ê²Œ ë²ˆí˜¸ìˆœ ì •ë ¬
      currentSeats.sort((a, b) => a.seatNumber - b.seatNumber);

      currentSeats.forEach(seat => {
        const option = document.createElement('option');
        option.value = seat.id;

        // ìƒíƒœì— ë”°ë¼ í…ìŠ¤íŠ¸ ë‹¤ë¥´ê²Œ (ê´€ë¦¬ìê°€ ë³´ê¸° í¸í•˜ê²Œ)
        let statusText = '';
        if (seat.status === 'RESERVED') statusText = ' (ì´ìš© ì¤‘)';
        else if (seat.status === 'UNUSABLE') statusText = ' (ğŸš« ì‚¬ìš© ë¶ˆê°€)';

        option.textContent = `${seat.seatNumber}ë²ˆ${statusText}`;
        seatSelect.appendChild(option);
      });

      seatSelect.disabled = false;
    } catch(e) { console.error(e); }
  }

  // ì¢Œì„ ì„ íƒ ì‹œ ë²„íŠ¼ í™œì„±í™”/ë¹„í™œì„±í™” ì²˜ë¦¬
  function updateSeatInfo() {
    const seatId = Number(document.getElementById('seat-select').value);
    const seat = currentSeats.find(s => s.id === seatId);

    const statusDisplay = document.getElementById('seat-status-display');
    const btnReturn = document.getElementById('btn-force-return');
    const btnDisable = document.getElementById('btn-disable-seat');

    if (!seat) {
      statusDisplay.textContent = '';
      return;
    }

    statusDisplay.textContent = `í˜„ì¬ ìƒíƒœ: ${seat.status}`;

    // ê°•ì œ ë°˜ë‚©ì€ 'ì˜ˆì•½ ì¤‘'ì¼ ë•Œë§Œ ê°€ëŠ¥
    btnReturn.disabled = (seat.status !== 'RESERVED');

    // ì‚¬ìš© ë¶ˆê°€ëŠ” ì´ë¯¸ 'ì‚¬ìš© ë¶ˆê°€'ê°€ ì•„ë‹ ë•Œë§Œ ê°€ëŠ¥
    btnDisable.disabled = (seat.status === 'UNUSABLE');
  }

  // [ì•¡ì…˜] ê°•ì œ ë°˜ë‚©
  async function handleForceReturn() {
    const seatId = document.getElementById('seat-select').value;
    if(!seatId) return;
    if(!confirm('ì‚¬ìš©ìë¥¼ ê°•ì œë¡œ í‡´ì‹¤ ì²˜ë¦¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    try {
      const res = await fetch(`/api/admin/seats/${seatId}/return`, { method: 'POST', credentials: 'same-origin' });
      const json = await res.json();
      if(res.ok) {
        alert(json.message);
        loadSeats(document.getElementById('room-select').value); // ìƒíƒœ ê°±ì‹ 
      } else {
        alert('ì˜¤ë¥˜: ' + json.message);
      }
    } catch(e) { console.error(e); }
  }

  // [ì•¡ì…˜] ì‚¬ìš© ë¶ˆê°€ ì²˜ë¦¬
  async function handleDisableSeat() {
    const seatId = document.getElementById('seat-select').value;
    if(!seatId) return;
    if(!confirm('ì´ ì¢Œì„ì„ [ì‚¬ìš© ë¶ˆê°€] ìƒíƒœë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(ì‚¬ìš©ìê°€ ìˆë‹¤ë©´ ê°•ì œ í‡´ì‹¤ë©ë‹ˆë‹¤.)')) return;

    try {
      const res = await fetch(`/api/admin/seats/${seatId}/disable`, { method: 'POST', credentials: 'same-origin' });
      const json = await res.json();
      if(res.ok) {
        alert(json.message);
        loadSeats(document.getElementById('room-select').value); // ìƒë‹¨ ê°±ì‹ 
        loadUnusableSeats(); // í•˜ë‹¨ ëª©ë¡ë„ ê°™ì´ ê°±ì‹ 
      } else {
        alert('ì˜¤ë¥˜: ' + json.message);
      }
    } catch(e) { console.error(e); }
  }


  // ===============================================
  // 3. í•˜ë‹¨: ì‚¬ìš© ë¶ˆê°€(ì‹ ê³ /ì ê²€) ì¢Œì„ ëª©ë¡ ë¡œì§
  // ===============================================
  async function loadUnusableSeats() {
    try {
      const res = await fetch('/api/admin/seats/unusable', { credentials: 'same-origin' });

      // ê´€ë¦¬ì ì•„ë‹ˆë©´ íŠ•ê²¨ë‚´ê¸°
      if(res.status === 403) { alert('ê´€ë¦¬ì ê¶Œí•œì´ ì—†ìŠµë‹ˆë‹¤.'); window.location.href='/'; return; }

      const seats = await res.json();
      const tbody = document.getElementById('unusable-list');
      tbody.innerHTML = '';

      if (!seats || seats.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align:center; padding: 20px;">í˜„ì¬ ë¬¸ì œìˆëŠ” ì¢Œì„ì´ ì—†ìŠµë‹ˆë‹¤. ğŸ˜Š</td></tr>';
        return;
      }

      seats.forEach(s => {
        const tr = document.createElement('tr');

        // ì‹ ê³  ì‚¬ìœ ê°€ ì—†ìœ¼ë©´ ê´€ë¦¬ìê°€ ì§ì ‘ ë§‰ì€ ê²ƒ
        let reason = `<span style="color:#888;">(ê´€ë¦¬ì ì§ê¶Œ ì„¤ì •)</span>`;
        if (s.category) {
          reason = `<strong style="color:#d9534f;">[${s.category}]</strong> ${s.detail}`;
        }

        let dateStr = '-';
        if (s.report_date) {
          const d = new Date(s.report_date);
          dateStr = `${d.getMonth()+1}/${d.getDate()} ${d.getHours()}:${d.getMinutes()}`;
        }

        tr.innerHTML = `
          <td><strong>${s.room_name}</strong><br><small>#${s.seat_number}</small></td>
          <td><span class="status-badge" style="background:#6c757d; color:white;">${s.status}</span></td>
          <td>${reason}</td>
          <td>${dateStr}</td>
          <td>
            <button class="btn btn-resolve" onclick="enableSeat(${s.seat_id})">ë³µêµ¬ (ì‚¬ìš© ê°€ëŠ¥)</button>
          </td>
        `;
        tbody.appendChild(tr);
      });
    } catch(e) { console.error(e); }
  }

  // [ì•¡ì…˜] ì¢Œì„ ë³µêµ¬ (Enable)
  async function enableSeat(seatId) {
    if(!confirm('ì¢Œì„ì„ [ì´ìš© ê°€ëŠ¥] ìƒíƒœë¡œ ë³µêµ¬í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\nê´€ë ¨ ì‹ ê³  ë‚´ì—­ë„ í•´ê²° ì²˜ë¦¬ë©ë‹ˆë‹¤.')) return;

    try {
      const res = await fetch(`/api/admin/seats/${seatId}/enable`, { method: 'POST', credentials: 'same-origin' });
      const json = await res.json();

      if(res.ok) {
        alert(json.message);
        loadUnusableSeats(); // í•˜ë‹¨ ëª©ë¡ ê°±ì‹ 

        // ìƒë‹¨ íŒ¨ë„ë„ ê°±ì‹  (ë§Œì•½ ê·¸ ë°©ì„ ë³´ê³  ìˆì—ˆë‹¤ë©´)
        const roomSelect = document.getElementById('room-select');
        if(roomSelect.value) loadSeats(roomSelect.value);
      } else {
        alert('ì˜¤ë¥˜: ' + json.message);
      }
    } catch(e) { console.error(e); }
  }

  // í˜ì´ì§€ ë¡œë“œ ì‹œ ì‹¤í–‰
  document.addEventListener('DOMContentLoaded', () => {
    loadUnusableSeats(); // ë¬¸ì œ ì¢Œì„ ëª©ë¡ ë¡œë“œ
    loadRooms();         // ìƒë‹¨ ì—´ëŒì‹¤ ëª©ë¡ ë¡œë“œ
  });
</script>
</body>
</html>